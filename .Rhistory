levels(df$scanner)[2]
df$md_maxb3_harm <- df$md_maxb3_harm + residuals(best_md_model, type='response')
library(gamlss2)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tibble)
library(formula.tools)
library(topmodels)
library(ggstatsplot)
df <- read.csv("~/urblauna/tpavan1/post_recon_LSP/covar_with_scanners_info_with_avgs_for_harm_in_R.csv")
df$age <- as.numeric(df$age)
df$volume <- df$total_brain - df$total_vent
df$scanner <- as.factor(df$scanner)
df$sex <- as.factor(df$sex)
df$dataset <- as.factor(df$dataset)
df$TE <- as.numeric(df$TE)
df$voxelsize <- as.numeric(df$voxelsize)
df$TR <- as.numeric(df$TR)
# MD model
f_md <- md_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re')+s(scanner, bs='re') | s(dataset, bs='re')
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
wormplot(best_md_model)
plot(best_md_model, which='hist-resid')
###############################################################################
df <- df[df$scanner != 'prisma_fit_67014',]
df
df$scanner
levels(df$scanner)
levels(droplevel(df$scanner))
levels(droplevels(df$scanner))
droplevels(df$scanner)
###############################################################################
df <- df[df$scanner != 'prisma_fit_67014',]
df <- droplevels(df$scanner)
# MD model
f_md <- md_maxb3 ~ pb(age, by=sex, k=4) + pb(volume, k=4) + sex + s(scanner, bs='re') | s(scanner, bs='re')
f_md <- md_maxb3 ~ te(age, ndir) + dataset
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
f_md <- md_maxb3 ~ te(age, ndir) + dataset
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
library(gamlss2)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tibble)
library(formula.tools)
library(topmodels)
library(ggstatsplot)
df <- read.csv("~/urblauna/tpavan1/post_recon_LSP/covar_with_scanners_info_with_avgs_for_harm_in_R.csv")
df$age <- as.numeric(df$age)
df$volume <- df$total_brain - df$total_vent
df$scanner <- as.factor(df$scanner)
df$sex <- as.factor(df$sex)
df$dataset <- as.factor(df$dataset)
df$TE <- as.numeric(df$TE)
df$voxelsize <- as.numeric(df$voxelsize)
df$TR <- as.numeric(df$TR)
###############################################################################
df <- df[df$scanner != 'prisma_fit_67014',]
droplevels(df$scanner)
df <- df[df$scanner != 'prisma_fit_67014',]
df$scanner <- droplevels(df$scanner)
# MD model
f_md <- md_maxb3 ~ pb(age, by=sex, k=4) + pb(volume, k=4) + sex + s(scanner, bs='re') | s(scanner, bs='re')
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
summary(best_md_model)
wormplot(best_md_model)
plot(best_md_model)
# plot
df_new <- df
df_new$scanner <- factor(levels(df$scanner)[2], levels=levels(df$scanner))
df_new$dataset <- factor(levels(df$dataset)[1], levels=levels(df$dataset))
df$md_maxb3_harm <- predict(best_md_model, newdata = df_new, type = "response")
df$md_maxb3_harm <- df$md_maxb3_harm + residuals(best_md_model, type='response')
ggplot(df, aes(x = age, y = md_maxb3_harm, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "HARM: MD vs Age by Dataset", x = "Age", y = "Mean Diffusivity (MD) HARMONIZED") +
theme_minimal() +
theme()
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt$age <- as.numeric(pt$age)
pt$volume <- pt$total_brain - pt$total_vent
pt$scanner <- as.factor(pt$scanner)
pt$sex <- as.factor(pt$sex)
pt$dataset <- as.factor(pt$dataset)
pt$dataset <- factor(pt$dataset, levels = levels(df$dataset))
pt$scanner <- factor(pt$scanner, levels = levels(df$scanner))
# Predict and assign family for gamlss2_zscore func
pred_md <- predict(best_md_model, newdata = pt, type = "parameter")
predictions_md <- list(pred=pred_md,
yvxldat=pt$MD_avg,
family=best_md_model$family$family)
pt$zscore_md <- gamlss2_zscore(predictions_md)
# ---------------------------------------------------------------------------
# ---------------------------------------------------------------------------
# zscore from gamlss2 pred function
gamlss2_zscore <- function(obj) {
pred <- obj$pred
yval <- obj$yvxldat
# get number of params
lpar <- sum(names(pred) %in% c("mu", "sigma", "nu", "tau"))
qfun <- paste("p",obj$family,sep="")
if (lpar == 1) {
newcall <- call(qfun, yval, mu = pred$mu)
} else if (lpar == 2) {
newcall <- call(qfun, yval, mu = pred$mu, sigma = pred$sigma)
} else if (lpar == 3) {
newcall <- call(qfun, yval, mu = pred$mu, sigma = pred$sigma, nu = pred$nu)
} else {
newcall <- call(qfun, yval, mu = pred$mu, sigma = pred$sigma, nu = pred$nu, tau = pred$tau)
}
cdf <- eval(newcall)
rqres <- qnorm(cdf)
return(rqres)
}
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt$age <- as.numeric(pt$age)
pt$volume <- pt$total_brain - pt$total_vent
pt$scanner <- as.factor(pt$scanner)
pt$sex <- as.factor(pt$sex)
pt$dataset <- as.factor(pt$dataset)
pt$dataset <- factor(pt$dataset, levels = levels(df$dataset))
pt$scanner <- factor(pt$scanner, levels = levels(df$scanner))
# Predict and assign family for gamlss2_zscore func
pred_md <- predict(best_md_model, newdata = pt, type = "parameter")
predictions_md <- list(pred=pred_md,
yvxldat=pt$MD_avg,
family=best_md_model$family$family)
pt$zscore_md <- gamlss2_zscore(predictions_md)
this_boxplot(pt, xvar=scanner, yvar=zscore_md, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MD")
# ---------------------------------------------------------------------------
# Plot MD and MK vs DATASET, SCANNER, TE, VXSIZE, NDIR
this_plot <- function(dframe, xvar, yvar, fill, title, ylab, xlab) {
p <- ggplot(dframe, aes(x = {{ xvar }}, y = {{ yvar }}, color = {{ fill }})) +
geom_point(alpha=0.15) +
geom_smooth(method = "lm", se = F) +
labs(title = title, x = xlab, y = ylab) +
theme_pubr() +
theme(
legend.position = c(0.99, 0.99),
legend.justification = c("right", "top"),
legend.key.size = unit(0.2, "cm"),
legend.title = element_text(size = 8, face = "bold"),
legend.text = element_text(size = 7),
legend.margin = margin(t = 2, r = 1, b = 2, l = 1),
axis.text.x = element_text(angle = 45, hjust = 1)
)
return(p)
}
this_boxplot <- function(dframe, xvar, yvar, fill, title='', ylab='', xlab='') {
p <- ggplot(dframe, aes(x = {{ xvar }}, y = {{ yvar }}, fill = {{ fill }})) +
geom_boxplot() +
labs(title = title, x = xlab, y = ylab) +
theme_pubr() +
theme(
#legend.position = c(0.99, 0.99),
#legend.justification = c("right", "top"),
legend.key.size = unit(0.3, "cm"),
legend.title = element_text(size = 8, face = "bold"),
legend.text = element_text(size = 7),
legend.margin = margin(t = 2, r = 2, b = 2, l = 2),
axis.text.x = element_text(angle = 45, hjust = 1)
)
return(p)
}
pt$dataset <- factor(pt$dataset, levels = levels(df$dataset))
pt$scanner <- factor(pt$scanner, levels = levels(df$scanner))
# Predict and assign family for gamlss2_zscore func
pred_md <- predict(best_md_model, newdata = pt, type = "parameter")
predictions_md <- list(pred=pred_md,
yvxldat=pt$MD_avg,
family=best_md_model$family$family)
pt$zscore_md <- gamlss2_zscore(predictions_md)
this_boxplot(pt, xvar=scanner, yvar=zscore_md, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MD")
ggbetweenstats(pt, x=scanner, y=zscore_md, fill=dataset, xlab="Scanner",
ylab="Patients' z-score MD", p.adjust.method = 'none')
AIC(best_md_model)
# -9620.393
ggbetweenstats(pt, x=scanner, y=zscore_md, fill=dataset, xlab="Scanner",
ylab="Patients' z-score MD", p.adjust.method = 'none')
# MD model
#f_md <- md_maxb3 ~ pb(age, by=sex, k=4) + pb(volume, k=4) + sex + s(scanner, bs='re') | s(scanner, bs='re')
f_md <- md_maxb3 ~ s(age, bs = "ps") + s(age, scanner, bs = "sz", xt = list(bs = "ps")) + scanner | s(scanner, bs='re')
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
summary(best_md_model)
wormplot(best_md_model)
plot(best_md_model)
# MD model
#f_md <- md_maxb3 ~ pb(age, by=sex, k=4) + pb(volume, k=4) + sex + s(scanner, bs='re') | s(scanner, bs='re')
f_md <- md_maxb3 ~ s(age, bs = "ps", k=4) + s(age, scanner, bs = "sz", xt = list(bs = "ps")) + scanner | s(scanner, bs='re')
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
summary(best_md_model)
wormplot(best_md_model)
plot(best_md_model)
wormplot(best_md_model)
plot(best_md_model)
# plot
df_new <- df
df_new$scanner <- factor(levels(df$scanner)[2], levels=levels(df$scanner))
df_new$dataset <- factor(levels(df$dataset)[1], levels=levels(df$dataset))
df$md_maxb3_harm <- predict(best_md_model, newdata = df_new, type = "response")
df$md_maxb3_harm <- df$md_maxb3_harm + residuals(best_md_model, type='response')
ggplot(df, aes(x = age, y = md_maxb3_harm, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "HARM: MD vs Age by Dataset", x = "Age", y = "Mean Diffusivity (MD) HARMONIZED") +
theme_minimal() +
theme()
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt$age <- as.numeric(pt$age)
pt$volume <- pt$total_brain - pt$total_vent
pt$scanner <- as.factor(pt$scanner)
pt$sex <- as.factor(pt$sex)
pt$dataset <- as.factor(pt$dataset)
pt$dataset <- factor(pt$dataset, levels = levels(df$dataset))
pt$scanner <- factor(pt$scanner, levels = levels(df$scanner))
# Predict and assign family for gamlss2_zscore func
pred_md <- predict(best_md_model, newdata = pt, type = "parameter")
predictions_md <- list(pred=pred_md,
yvxldat=pt$MD_avg,
family=best_md_model$family$family)
pt$zscore_md <- gamlss2_zscore(predictions_md)
this_boxplot(pt, xvar=scanner, yvar=zscore_md, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MD")
ggbetweenstats(pt, x=scanner, y=zscore_md, fill=dataset, xlab="Scanner",
ylab="Patients' z-score MD", p.adjust.method = 'none')
AIC(best_md_model)
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt <- pt[pt$scanner != 'prisma_fit_67014',]
pt$scanner <- droplevels(pt$scanner)
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt <- pt[pt$scanner != 'prisma_fit_67014',]
pt$scanner <- droplevels(pt$scanner)
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt$age <- as.numeric(pt$age)
pt$volume <- pt$total_brain - pt$total_vent
pt$scanner <- as.factor(pt$scanner)
pt$sex <- as.factor(pt$sex)
pt$dataset <- as.factor(pt$dataset)
pt <- pt[pt$scanner != 'prisma_fit_67014',]
pt$scanner <- droplevels(pt$scanner)
pt$dataset <- factor(pt$dataset, levels = levels(df$dataset))
pt$scanner <- factor(pt$scanner, levels = levels(df$scanner))
# Predict and assign family for gamlss2_zscore func
pred_md <- predict(best_md_model, newdata = pt, type = "parameter")
predictions_md <- list(pred=pred_md,
yvxldat=pt$MD_avg,
family=best_md_model$family$family)
pt$zscore_md <- gamlss2_zscore(predictions_md)
this_boxplot(pt, xvar=scanner, yvar=zscore_md, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MD")
ggbetweenstats(pt, x=scanner, y=zscore_md, fill=dataset, xlab="Scanner",
ylab="Patients' z-score MD", p.adjust.method = 'none')
pt$zscore_md
pt <- pt[!is.infinite(rowSums(pt)),]
pt <- pt[!is.infinite(pt$zscore_md),]
this_boxplot(pt, xvar=scanner, yvar=zscore_md, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MD")
ggbetweenstats(pt, x=scanner, y=zscore_md, fill=dataset, xlab="Scanner",
ylab="Patients' z-score MD", p.adjust.method = 'none')
?ggbetweenstats
library(gamlss2)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tibble)
library(formula.tools)
library(topmodels)
library(ggstatsplot)
df <- read.csv("~/urblauna/tpavan1/post_recon_LSP/covar_with_scanners_info_with_avgs_for_harm_in_R.csv")
df$age <- as.numeric(df$age)
df$volume <- df$total_brain - df$total_vent
df$scanner <- as.factor(df$scanner)
df$sex <- as.factor(df$sex)
df$dataset <- as.factor(df$dataset)
df$TE <- as.numeric(df$TE)
df$voxelsize <- as.numeric(df$voxelsize)
df$TR <- as.numeric(df$TR)
df <- df[df$scanner != 'prisma_fit_67014',]
df$scanner <- droplevels(df$scanner)
# ---------------------------------------------------------------------------
# Plot MD and MK vs DATASET, SCANNER, TE, VXSIZE, NDIR
this_plot <- function(dframe, xvar, yvar, fill, title, ylab, xlab) {
p <- ggplot(dframe, aes(x = {{ xvar }}, y = {{ yvar }}, color = {{ fill }})) +
geom_point(alpha=0.15) +
geom_smooth(method = "lm", se = F) +
labs(title = title, x = xlab, y = ylab) +
theme_pubr() +
theme(
legend.position = c(0.99, 0.99),
legend.justification = c("right", "top"),
legend.key.size = unit(0.2, "cm"),
legend.title = element_text(size = 8, face = "bold"),
legend.text = element_text(size = 7),
legend.margin = margin(t = 2, r = 1, b = 2, l = 1),
axis.text.x = element_text(angle = 45, hjust = 1)
)
return(p)
}
this_boxplot <- function(dframe, xvar, yvar, fill, title='', ylab='', xlab='') {
p <- ggplot(dframe, aes(x = {{ xvar }}, y = {{ yvar }}, fill = {{ fill }})) +
geom_boxplot() +
labs(title = title, x = xlab, y = ylab) +
theme_pubr() +
theme(
#legend.position = c(0.99, 0.99),
#legend.justification = c("right", "top"),
legend.key.size = unit(0.3, "cm"),
legend.title = element_text(size = 8, face = "bold"),
legend.text = element_text(size = 7),
legend.margin = margin(t = 2, r = 2, b = 2, l = 2),
axis.text.x = element_text(angle = 45, hjust = 1)
)
return(p)
}
A1 <- this_plot(df, xvar=md_maxb3, yvar=mk_maxb3, fill=dataset,
title="Dataset", ylab="Mean Diffusivity (MD)", xlab="Mean Kurtosis (MK)")
A2 <- this_plot(df, xvar=md_maxb3, yvar=mk_maxb3, fill=scanner,
title="Scanner", ylab="Mean Diffusivity (MD)", xlab="Mean Kurtosis (MK)")
A3 <- this_plot(df, xvar=md_maxb3, yvar=mk_maxb3, fill=factor(TE),
title="TE", ylab="Mean Diffusivity (MD)", xlab="Mean Kurtosis (MK)")
A4 <- this_plot(df, xvar=md_maxb3, yvar=mk_maxb3, fill=factor(voxelsize),
title="Voxel size [mm^3]", ylab="Mean Diffusivity (MD)", xlab="Mean Kurtosis (MK)")
A5 <- this_plot(df, xvar=md_maxb3, yvar=mk_maxb3, fill=factor(ndir),
title="Number of directions", ylab="Mean Diffusivity (MD)", xlab="Mean Kurtosis (MK)")
B1 <- this_boxplot(df, xvar=dataset, yvar=md_maxb3, fill=scanner,
xlab="Dataset", ylab="Mean Diffusivity (MD)")
B2 <- this_boxplot(df, xvar=scanner, yvar=md_maxb3, fill=dataset,
xlab="Scanner", ylab="Mean Diffusivity (MD)")
C1 <- this_boxplot(df, xvar=dataset, yvar=mk_maxb3, fill=scanner,
xlab="Dataset", ylab="Mean Kurtosis (MK)")
C2 <- this_boxplot(df, xvar=scanner, yvar=mk_maxb3, fill=dataset,
xlab="Scanner", ylab="Mean Kurtosis (MK)")
# plot 1 the two together as subplots
ggarrange(A1, A3, A4, A2, A5,
ncol = 3, nrow=2, align = "hv",
labels = c("A", "B", "C", "D", "E"))
# plot 2 the two together as subplots
ggarrange(B1, B2, C1, C2,
ncol = 2, nrow=2, align = "hv",
labels = c("A", "B", "C", "D"))
new_formula_gd <- function(a) {
ab <- new_formula(a)
return(c(as.character(ab$mu), as.character(ab$sigma), round(GAIC(a),1)))
}
empty <- data.frame(row.names = c("AIC MD", "AIC MK"),
mu = character(2),
sigma = character(2),
GD = character(2),
stringsAsFactors = FALSE)
# MD b3
f3 <- md_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re')+s(scanner, bs='re')+s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re') | s(dataset, bs='re')+s(scanner, bs='re')+s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re')
winner_md <- select_gamlss2(f3, data = df, family = NO, criterion = "BIC", maxit = c(300, 100))
empty["AIC MD",]  <- new_formula_gd(winner_md)
# MK b3
f4 <- mk_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re')+s(scanner, bs='re')+ s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re') | s(dataset, bs='re')+s(scanner, bs='re')+s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re')
winner_mk <- select_gamlss2(f4, data = df, family = NO, criterion = "BIC", maxit = c(300, 100))
empty["AIC MK",] <- new_formula_gd(winner_mk)
# plot results
tth = ttheme("default")
p <- ggtexttable(empty, theme = tth)
ggarrange(p,
ncol = 1, nrow = 1,
labels = c("MD", "MK"))
new_formula_gd <- function(a) {
ab <- new_formula(a)
return(c(as.character(ab$mu), as.character(ab$sigma), round(GAIC(a),1)))
}
empty <- data.frame(row.names = c("AIC MD", "AIC MK"),
mu = character(2),
sigma = character(2),
GD = character(2),
stringsAsFactors = FALSE)
# MD b3
f3 <- md_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re')+s(scanner, bs='re')+s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re') | s(dataset, bs='re')+s(scanner, bs='re')+s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re')
winner_md <- select_gamlss2(f3, data = df, family = NO, criterion = "AIC", maxit = c(300, 100))
empty["AIC MD",]  <- new_formula_gd(winner_md)
# MK b3
f4 <- mk_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re')+s(scanner, bs='re')+ s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re') | s(dataset, bs='re')+s(scanner, bs='re')+s(TE, bs='re') +s(voxelsize, bs='re')+s(TR, bs='re')
winner_mk <- select_gamlss2(f4, data = df, family = NO, criterion = "AIC", maxit = c(300, 100))
empty["AIC MK",] <- new_formula_gd(winner_mk)
# plot results
tth = ttheme("default")
p <- ggtexttable(empty, theme = tth)
ggarrange(p,
ncol = 1, nrow = 1,
labels = c("MD", "MK"))
# MD model
f_md <- md_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re') | s(dataset, bs='re')
best_md_model <- gamlss2(f_md, data = df, family = NO, maxit = c(300, 100))
plot(best_md_model)
# MK model
f_mk <- mk_maxb3 ~ pb(age, by=sex) + pb(volume) + sex + s(dataset, bs='re') | s(dataset, bs='re')  +s(scanner, bs='re')
best_mk_model <- gamlss2(f_mk, data = df, family = NO, maxit = c(300, 100))
plot(best_mk_model)
# MD plot
# predict removing scanner and dataset effects
df_new <- df
df_new$scanner <- factor(levels(df$scanner)[2], levels=levels(df$scanner))
df_new$dataset <- factor(levels(df$dataset)[1], levels=levels(df$dataset))
df$md_maxb3_harm <- predict(best_md_model, newdata = df_new, type = "response")
df$md_maxb3_harm <- df$md_maxb3_harm + residuals(best_md_model, type='response')
plot_md_harm <- ggplot(df, aes(x = age, y = md_maxb3_harm, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "HARM: MD vs Age by Dataset", x = "Age", y = "Mean Diffusivity (MD) HARMONIZED") +
theme_minimal() +
theme()
plot_md_harm
# MD plot
# predict removing scanner and dataset effects
df_new <- df
df_new$scanner <- factor(levels(df$scanner)[2], levels=levels(df$scanner))
df_new$dataset <- factor(levels(df$dataset)[1], levels=levels(df$dataset))
df$md_maxb3_harm <- predict(best_md_model, newdata = df_new, type = "response")
df$md_maxb3_harm <- df$md_maxb3_harm + residuals(best_md_model, type='response')
plot_md_harm <- ggplot(df, aes(x = age, y = md_maxb3_harm, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "HARM: MD vs Age by Dataset", x = "Age", y = "Mean Diffusivity (MD) HARMONIZED") +
theme_minimal() +
theme()
# MK plot
# predict removing scanner and dataset effects
df_new <- df
df_new$scanner <- factor(levels(df$scanner)[2], levels=levels(df$scanner))
df_new$dataset <- factor(levels(df$dataset)[1], levels=levels(df$dataset))
df$mk_maxb3_harm <- predict(best_mk_model, newdata = df_new, type = "response")
df$mk_maxb3_harm <- df$mk_maxb3_harm + residuals(best_mk_model, type='response')
plot_mk_harm <- ggplot(df, aes(x = age, y = mk_maxb3_harm, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "HARM: MK vs Age by Dataset", x = "Age", y = "Mean Kurtosis (MK) HARMONIZED") +
theme_minimal() +
theme()
### references:
mdb3post <-  ggplot(df, aes(x = age, y = md_maxb3, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "POST: MK vs Age by Dataset", x = "Age", y = "Mean Diffusivity (MD)") +
theme_minimal() +
theme(legend.position = "none")
mkb3post <-  ggplot(df, aes(x = age, y = mk_maxb3, color=dataset)) +
geom_point(alpha=0.15) +
geom_smooth(se=FALSE, method = "lm", formula = y ~ poly(x,2)) +
labs(title = "POST: MK vs Age by Dataset", x = "Age", y = "Mean Kurtosis (MK)") +
theme_minimal() + theme(legend.position = "bottom")
# plot the two together as subplots
ggarrange(mdb3post, plot_md_harm, ncol = 2, nrow=1, common.legend = TRUE, legend = "right")
ggarrange(mkb3post, plot_mk_harm,  ncol = 2, nrow=1, common.legend = TRUE, legend = "right")
ggarrange(plot_md_harm, plot_mk_harm,  ncol = 2, nrow=1, common.legend = TRUE, legend = "right")
# zscore from gamlss2 pred function
gamlss2_zscore <- function(obj) {
pred <- obj$pred
yval <- obj$yvxldat
# get number of params
lpar <- sum(names(pred) %in% c("mu", "sigma", "nu", "tau"))
qfun <- paste("p",obj$family,sep="")
if (lpar == 1) {
newcall <- call(qfun, yval, mu = pred$mu)
} else if (lpar == 2) {
newcall <- call(qfun, yval, mu = pred$mu, sigma = pred$sigma)
} else if (lpar == 3) {
newcall <- call(qfun, yval, mu = pred$mu, sigma = pred$sigma, nu = pred$nu)
} else {
newcall <- call(qfun, yval, mu = pred$mu, sigma = pred$sigma, nu = pred$nu, tau = pred$tau)
}
cdf <- eval(newcall)
rqres <- qnorm(cdf)
return(rqres)
}
# ---------------------------------------------------------------------------
# TRY predicting patients
pt <- read.csv("~/urblauna/tpavan1/post_recon_LSP/patients_+regpaths+longit+group+mdmkavg+scanner_info_for_harm_in_R.csv")
pt$age <- as.numeric(pt$age)
pt$volume <- pt$total_brain - pt$total_vent
pt$scanner <- as.factor(pt$scanner)
pt$sex <- as.factor(pt$sex)
pt$dataset <- as.factor(pt$dataset)
pt <- pt[pt$scanner != 'prisma_fit_67014',]
pt$scanner <- droplevels(pt$scanner)
pt$dataset <- factor(pt$dataset, levels = levels(df$dataset))
pt$scanner <- factor(pt$scanner, levels = levels(df$scanner))
# Predict and assign family for gamlss2_zscore func
pred_md <- predict(best_md_model, newdata = pt, type = "parameter")
predictions_md <- list(pred=pred_md,
yvxldat=pt$MD_avg,
family=best_md_model$family$family)
pred_mk <- predict(best_mk_model, newdata = pt, type = "parameter")
predictions_mk <- list(pred=pred_mk,
yvxldat=pt$MK_avg,
family=best_mk_model$family$family)
pt$zscore_md <- gamlss2_zscore(predictions_md)
pt$zscore_mk <- gamlss2_zscore(predictions_mk)
P1 <- this_boxplot(pt, xvar=scanner, yvar=zscore_md, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MD")
P2 <- this_boxplot(pt, xvar=scanner, yvar=zscore_mk, fill=dataset,
xlab="Scanner", ylab="Patients' z-score MK")
# plot 1 the two together as subplots
ggarrange(P1, P2,
ncol = 2, nrow=1, align = "hv",
labels = c("A", "B"))
T1 <- ggbetweenstats(pt, x=scanner, y=zscore_md, fill=dataset, xlab="Scanner", ylab="Patients' z-score MD", p.adjust.method = 'none')
T2 <- ggbetweenstats(pt, x=scanner, y=zscore_mk, fill=dataset, xlab="Scanner", ylab="Patients' z-score MK", p.adjust.method = 'none')
# plot 1 the two together as subplots
ggarrange(T1, T2,
ncol = 2, nrow=1, align = "hv",
labels = c("A", "B"))
